import{r as s,j as e,bv as J,bp as L}from"./react-vendor-ZT4qGmQJ.js";import{u as B}from"./admin-shared-zSvU8R3T.js";import{u as q,a as G,b as H,B as o,C as I,c as A}from"./admin-dashboard-D0amimT5.js";function K(P={}){const{user:j}=q(),{currentRestaurant:h}=G(),{tableId:S,restaurantId:k=(h==null?void 0:h.id)??void 0,autoReconnect:y=!0,maxReconnectAttempts:m=5,reconnectInterval:l=3e3}=P,[f,C]=s.useState(!1),[b,N]=s.useState(!1),[$,x]=s.useState("disconnected"),[t,r]=s.useState([]),[M,a]=s.useState(null),c=s.useRef(null),v=s.useRef(0),p=s.useRef(null),g=s.useRef(null),z=s.useRef(Date.now()),R=s.useCallback(()=>{var i;if(!(typeof window>"u")&&((i=c.current)==null?void 0:i.readyState)!==WebSocket.OPEN){x("connecting"),a(null),p.current&&(clearTimeout(p.current),p.current=null);try{const d=window.location.protocol==="https:"?"wss:":"ws:";let W;const D=window.location.host;W=`${d}//${D}/ws`,console.log("Attempting WebSocket connection to:",W);const w=new WebSocket(W);c.current=w,w.onopen=()=>{if(console.log("WebSocket connected"),C(!0),x("connected"),v.current=0,E(),j&&!S){const u={type:"auth",userId:j.id,token:`merchant-${j.id}-${Date.now()}`};w.send(JSON.stringify(u))}else if(S&&k){const u={type:"table_auth",tableId:S,restaurantId:k};w.send(JSON.stringify(u))}},w.onclose=u=>{if(console.log("WebSocket disconnected:",u.code,u.reason),C(!1),N(!1),x("disconnected"),g.current&&(clearInterval(g.current),g.current=null),y&&u.code!==1e3&&v.current<m){const n=Math.min(l*Math.pow(2,v.current),3e4);console.log(`Attempting reconnection in ${n}ms (attempt ${v.current+1}/${m})`),p.current=setTimeout(()=>{v.current++,R()},n)}else v.current>=m&&(a(`Failed to reconnect after ${m} attempts`),x("error"))},w.onerror=u=>{console.error("WebSocket error:",u),a("WebSocket connection error"),x("error")},w.onmessage=u=>{try{const n=JSON.parse(u.data);(n.type==="auth"||n.type==="table_auth")&&("success"in n&&n.success?(N(!0),console.log("WebSocket authenticated successfully")):(N(!1),a("error"in n?n.error??"Authentication failed":"Authentication failed"),console.error("WebSocket authentication failed:","error"in n?n.error:"Unknown error"))),n.type==="pong"&&(z.current=Date.now()),n.type==="error"&&(console.error("WebSocket server error:",n.message),a(n.message)),r(U=>[...U,n])}catch(n){console.error("Failed to parse WebSocket message:",n),a("Failed to parse server message")}}}catch(d){console.error("Failed to create WebSocket connection:",d),a("Failed to create WebSocket connection"),x("error")}}},[j,S,k,y,m,l]),E=s.useCallback(()=>{g.current&&clearInterval(g.current),g.current=setInterval(()=>{var i;if(((i=c.current)==null?void 0:i.readyState)===WebSocket.OPEN&&b){const d={type:"ping",timestamp:Date.now()};c.current.send(JSON.stringify(d)),Date.now()-z.current>15e3&&(console.warn("WebSocket ping timeout - connection may be stale"),c.current.close())}},3e4)},[b]);s.useEffect(()=>(R(),()=>{c.current&&c.current.close(1e3,"Component unmounting"),p.current&&clearTimeout(p.current),g.current&&clearInterval(g.current)}),[R]);const O=s.useCallback(i=>{var d;if(((d=c.current)==null?void 0:d.readyState)===WebSocket.OPEN&&b)try{return c.current.send(JSON.stringify(i)),!0}catch(W){return console.error("Failed to send WebSocket message:",W),a("Failed to send message"),!1}return b?(console.warn("Cannot send message: WebSocket not connected"),a("WebSocket not connected")):(console.warn("Cannot send message: WebSocket not authenticated"),a("WebSocket not authenticated")),!1},[b]),_=s.useCallback(()=>{c.current&&c.current.close(),v.current=0,R()},[R]),F=s.useCallback(()=>{p.current&&(clearTimeout(p.current),p.current=null),c.current&&c.current.close(1e3,"Manual disconnect")},[]),T=s.useCallback(()=>{r([])},[]);return{isConnected:f,isAuthenticated:b,connectionState:$,messages:t,lastError:M,sendMessage:O,clearMessages:T,reconnect:_,disconnect:F,sendOrderUpdate:s.useCallback(i=>O({type:"update_order_status",order:i}),[O]),sendNewOrder:s.useCallback(i=>O({type:"new_order",order:i}),[O])}}function Q(){const{orders:P,isLoading:j,updateOrderStatus:h,exportOrders:S,filterOrdersByStatus:k}=B(),{messages:y}=K(),{toast:m}=H(),[l,f]=s.useState(null),[C,b]=s.useState([]),N=s.useRef([]);s.useEffect(()=>{b(k(l))},[l,P]),s.useEffect(()=>{y.slice(N.current.length).forEach(r=>{var M;if(r.type==="new_order"&&"order"in r){const a=r.order;m({title:"New Order Received!",description:`Table ${((M=a.table)==null?void 0:M.number)||"Unknown"} placed a new order`})}else if(r.type==="order_status_updated"&&"order"in r){const a=r.order;m({title:"Order Status Updated",description:`Order #${a.orderNumber} is now ${a.status}`})}}),N.current=y},[y,m]);const $=t=>`$${(t/100).toFixed(2)}`,x=t=>{switch(t){case"Received":return"status-received";case"Preparing":return"status-preparing";case"Ready":return"status-ready";case"Served":return"status-served";case"Cancelled":return"status-cancelled";default:return"bg-neutral-500"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Orders"}),e.jsxs(o,{variant:"outline",size:"sm",onClick:S,children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Export"]})]}),e.jsx(I,{children:e.jsxs(A,{className:"p-2 flex gap-2 overflow-x-auto",children:[e.jsx(o,{variant:l===null?"default":"outline",size:"sm",className:"whitespace-nowrap rounded-full",onClick:()=>f(null),children:"All Orders"}),e.jsx(o,{variant:l==="Received"?"default":"outline",size:"sm",className:"whitespace-nowrap rounded-full",onClick:()=>f("Received"),children:"Received"}),e.jsx(o,{variant:l==="Preparing"?"default":"outline",size:"sm",className:"whitespace-nowrap rounded-full",onClick:()=>f("Preparing"),children:"Preparing"}),e.jsx(o,{variant:l==="Ready"?"default":"outline",size:"sm",className:"whitespace-nowrap rounded-full",onClick:()=>f("Ready"),children:"Ready"}),e.jsx(o,{variant:l==="Served"?"default":"outline",size:"sm",className:"whitespace-nowrap rounded-full",onClick:()=>f("Served"),children:"Served"}),e.jsx(o,{variant:l==="Cancelled"?"default":"outline",size:"sm",className:"whitespace-nowrap rounded-full",onClick:()=>f("Cancelled"),children:"Cancelled"})]})}),e.jsx("div",{className:"space-y-4",children:j?e.jsx("div",{className:"flex justify-center p-8",children:e.jsx(L,{className:"h-8 w-8 animate-spin text-primary"})}):C.length===0?e.jsx(I,{children:e.jsxs(A,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"No orders found"}),l&&e.jsx(o,{variant:"link",onClick:()=>f(null),className:"mt-2",children:"Clear filter"})]})}):C.map(t=>e.jsx(I,{className:"order-card",children:e.jsxs(A,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:t.orderNumber}),e.jsxs("span",{className:"text-sm text-neutral-500 ml-2",children:["Table ",t.table.number]})]}),e.jsx("div",{className:`status-badge ${x(t.status)}`,children:e.jsx("span",{children:t.status})})]}),e.jsx("div",{className:"text-sm text-neutral-600 mb-2",children:new Date(t.createdAt).toLocaleString()}),e.jsx("div",{className:"border-t border-b border-neutral-200 py-2 my-2",children:t.orderItems.map(r=>e.jsxs("div",{className:"flex justify-between text-sm py-1",children:[e.jsxs("div",{children:[r.quantity,"x ",r.menuItem.name]}),e.jsx("div",{children:$(r.price*r.quantity)})]},r.id))}),e.jsxs("div",{className:"flex justify-between font-bold my-2",children:[e.jsx("div",{children:"Total"}),e.jsx("div",{children:$(t.total)})]}),e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("p",{className:"text-sm font-medium text-neutral-500 mb-2",children:"Update Order Status"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(o,{size:"sm",variant:"outline",className:`transition-all duration-200 ${t.status==="Preparing"?"bg-warning/20 text-warning border-warning":"hover:bg-warning hover:text-white hover:border-warning"}`,onClick:()=>h(t.id,"Preparing"),disabled:t.status==="Preparing"||t.status==="Served"||t.status==="Cancelled",children:e.jsx("span",{className:"flex items-center justify-center w-full",children:"Preparing"})}),e.jsx(o,{size:"sm",variant:"outline",className:`transition-all duration-200 ${t.status==="Ready"?"bg-success/20 text-success border-success":"hover:bg-success hover:text-white hover:border-success"}`,onClick:()=>h(t.id,"Ready"),disabled:t.status==="Ready"||t.status==="Served"||t.status==="Cancelled"||t.status!=="Preparing",children:e.jsx("span",{className:"flex items-center justify-center w-full",children:"Ready"})}),e.jsx(o,{size:"sm",variant:"outline",className:`transition-all duration-200 ${t.status==="Served"?"bg-blue-500/20 text-blue-500 border-blue-500":"hover:bg-blue-500 hover:text-white hover:border-blue-500"}`,onClick:()=>h(t.id,"Served"),disabled:t.status==="Served"||t.status==="Cancelled"||t.status!=="Ready",children:e.jsx("span",{className:"flex items-center justify-center w-full",children:"Served"})}),e.jsx(o,{size:"sm",variant:"outline",className:`transition-all duration-200 ${t.status==="Cancelled"?"bg-destructive/20 text-destructive border-destructive":"hover:bg-destructive hover:text-white hover:border-destructive"}`,onClick:()=>h(t.id,"Cancelled"),disabled:t.status==="Cancelled"||t.status==="Served",children:e.jsx("span",{className:"flex items-center justify-center w-full",children:"Cancel"})})]})]})]})},t.id))})]})}const Z=Object.freeze(Object.defineProperty({__proto__:null,OrderManagement:Q},Symbol.toStringTag,{value:"Module"}));export{Z as o,K as u};
